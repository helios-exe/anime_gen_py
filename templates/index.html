<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real or Fake Anime</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
  <div class="container">

    <h1 id="mainText">Which of these is a real anime?</h1>

    <div id="options" class="options-container"></div>

    <p id="feedback" class="feedback"></p>

    <p class="score">
      Score: <span id="scoreValue">0</span><br>
      High Score: <span id="highScoreValue">0</span>
    </p>

    <button id="nextBtn" onclick="nextRound()">Next</button>

  </div>

  <script>
    let realTitles = [];
    let currentOptions = [];
    let correctAnswer = "";
    let answered = false;

    // Streak score always starts at 0
    let score = 0;

    // Session high score
    let sessionHigh = parseInt(sessionStorage.getItem("sessionHigh") || "0");
    document.getElementById("highScoreValue").innerText = sessionHigh;

    document.getElementById("scoreValue").innerText = score;

    // Load 25k titles.json ONCE
    async function loadTitles() {
      const res = await fetch("/static/titles.json");
      realTitles = await res.json();
      nextRound(); 
    }

    // Pick a random real title
    function pickRealTitle() {
      const item = realTitles[Math.floor(Math.random() * realTitles.length)];
      return item.title_english || item.title;
    }

    // Fetch fake (Markov) title from backend
    async function fetchFakeTitle() {
      const res = await fetch("/generate");
      const data = await res.json();
      return data.title;
    }

    // Disable all option buttons after a choice
    function disableButtons() {
      document.querySelectorAll(".option-btn").forEach(btn => {
        btn.disabled = true;
      });
    }

    // Build round
    async function nextRound() {
      document.getElementById("feedback").innerText = "";
      answered = false;

      const real = pickRealTitle();
      const fake = await fetchFakeTitle();

      currentOptions = [
        { text: real, isReal: true },
        { text: fake, isReal: false }
      ];

      // Randomize order
      currentOptions.sort(() => Math.random() - 0.5);

      const container = document.getElementById("options");
      container.innerHTML = "";

      currentOptions.forEach((opt, index) => {
        const btn = document.createElement("button");
        btn.className = "option-btn";
        btn.innerText = opt.text;
        btn.onclick = () => checkAnswer(index);
        container.appendChild(btn);
      });
    }

    // Handle guessing
    function checkAnswer(idx) {
      if (answered) return;
      answered = true;

      disableButtons();

      const chosen = currentOptions[idx];
      const feedback = document.getElementById("feedback");

      if (chosen.isReal) {
        feedback.innerText = "✅ Correct!";
        score++;
      } else {
        const realOne = currentOptions.find(o => o.isReal).text;
        feedback.innerText = "❌ Wrong — the real one was:\n" + realOne;
        score = 0;
      }

      // Update visible score
      document.getElementById("scoreValue").innerText = score;

      // Update session high score
      if (score > sessionHigh) {
        sessionHigh = score;
        sessionStorage.setItem("sessionHigh", sessionHigh);
        document.getElementById("highScoreValue").innerText = sessionHigh;
      }
    }

    // Load titles when page opens
    window.onload = loadTitles;

  </script>

</body>
</html>
